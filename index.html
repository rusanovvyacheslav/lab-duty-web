<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Lab Duty ‚Äî Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .col { display: flex; flex-direction: column; gap: 8px; }
    .hidden { display: none !important; }
    .btn { padding: 8px 12px; border: 1px solid #8884; border-radius: 8px; cursor: pointer; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .tag { display: inline-block; padding: 2px 8px; border: 1px solid #8884; border-radius: 999px; font-size: 12px; }
    .card { border: 1px solid #8884; border-radius: 12px; padding: 12px; margin: 8px 0; }
    .meta { font-size: 12px; opacity: .7; display:flex; gap:8px; flex-wrap: wrap; }
    .resolved { background: #15a34a22; } /* –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
    .error { color: #b91c1c; font-size: 12px; margin: 4px 0; }
    .ok { color: #15803d; font-size: 12px; margin: 4px 0; }
    .hr { height:1px; background:#8884; margin:12px 0; }
    input[type="text"], input[type="date"], textarea, select {
      padding: 8px; border:1px solid #8884; border-radius:8px; min-width: 220px;
      background: transparent; color: inherit;
    }
    textarea { width: 100%; min-height: 80px; }
    .chips { display:flex; gap:6px; flex-wrap: wrap; }
  </style>
</head>
<body>

  <h1>Lab Duty ‚Äî Chat</h1>

  <div id="authBox" class="card">
    <div class="row">
      <div class="col">
        <div><b>–í—Ö–æ–¥</b></div>
        <input id="email" type="text" placeholder="email@example.com" />
        <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
        <div class="row">
          <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
          <button id="btnRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          <button id="btnSignOut" class="btn" disabled>–í—ã–π—Ç–∏</button>
        </div>
        <div id="authMsg" class="error"></div>
      </div>

      <div class="col">
        <div><b>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b></div>
        <div id="whoami">‚Äî</div>
        <div class="chips">
          <span id="chipAdmin" class="tag hidden">admin</span>
          <span id="chipTeam" class="tag hidden"></span>
        </div>
      </div>
    </div>
  </div>

  <div id="adminBox" class="card hidden">
    <div class="row" style="justify-content: space-between;">
      <div class="col">
        <div><b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b></div>
        <div class="meta">–ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å "–æ—Ç –∏–º–µ–Ω–∏".</div>
      </div>
      <div class="col">
        <label>–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—è:</label>
        <select id="postAsSelect">
          <option value="">‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
        </select>
        <div class="meta" id="postAsHint">–ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –æ—Ç –≤–∞—à–µ–≥–æ –∏–º–µ–Ω–∏ (–∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div><b>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b></div>
    <textarea id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" ></textarea>
    <div class="row">
      <button id="btnPublish" class="btn" disabled>Publish</button>
      <span class="meta">–í–∏–¥–∏–º–æ—Å—Ç—å: –≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞</span>
    </div>
    <div id="pubMsg" class="ok"></div>
  </div>

  <div class="card">
    <div><b>Swap offer</b></div>
    <div class="row">
      <div class="col">
        <label>–û—Ç (teamId):</label>
        <input id="swapFrom" type="text" placeholder="vanina" />
      </div>
      <div class="col">
        <label>–ö–æ–º—É (teamId):</label>
        <input id="swapTo" type="text" placeholder="slava" />
      </div>
      <div class="col">
        <label>–ú–æ—è –¥–∞—Ç–∞ (YYYY-MM-DD):</label>
        <input id="swapDate" type="date" />
      </div>
      <div class="col">
        <label>–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞ –¥–∞—Ç—É (YYYY-MM-DD):</label>
        <input id="swapAskDate" type="date" />
      </div>
    </div>
    <div class="row">
      <button id="btnSwapOffer" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å swap offer</button>
      <span class="meta">–í–∏–¥–∏–º–æ—Å—Ç—å: –æ–±–µ –∫–æ–º–∞–Ω–¥—ã (from/to)</span>
    </div>
    <div id="swapMsg" class="ok"></div>
  </div>

  <div class="card">
    <div><b>Submit checklist</b></div>
    <div class="col">
      <label><input type="checkbox" class="chk" /> –ü—É–Ω–∫—Ç 1</label>
      <label><input type="checkbox" class="chk" /> –ü—É–Ω–∫—Ç 2</label>
      <label><input type="checkbox" class="chk" /> –ü—É–Ω–∫—Ç 3</label>
    </div>
    <div class="row">
      <button id="btnSubmitChecklist" class="btn">Submit checklist</button>
      <span class="meta">–í—Å–µ –ø—É–Ω–∫—Ç—ã –æ–±—è–∑–∞–Ω—ã –±—ã—Ç—å –æ—Ç–º–µ—á–µ–Ω—ã</span>
    </div>
    <div id="chkMsg" class="ok"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <b>–°–æ–æ–±—â–µ–Ω–∏—è</b>
      <div class="meta" id="feedInfo">‚Äî</div>
    </div>
    <div id="feed"></div>
    <div id="feedErr" class="error"></div>
  </div>

  <script type="module">
    // ---------- Firebase SDK (v10 modular) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      serverTimestamp, addDoc, collection, query, orderBy, limit,
      where, onSnapshot, collectionGroup
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ---- CONFIG (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è) ----
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ---------- Init ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- UI refs ----------
    const whoami = document.getElementById('whoami');
    const chipAdmin = document.getElementById('chipAdmin');
    const chipTeam = document.getElementById('chipTeam');
    const authMsg = document.getElementById('authMsg');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnRegister = document.getElementById('btnRegister');
    const btnSignOut = document.getElementById('btnSignOut');

    const adminBox = document.getElementById('adminBox');
    const postAsSelect = document.getElementById('postAsSelect');
    const postAsHint = document.getElementById('postAsHint');

    const msgText = document.getElementById('msgText');
    const btnPublish = document.getElementById('btnPublish');
    const pubMsg = document.getElementById('pubMsg');

    const swapFrom = document.getElementById('swapFrom');
    const swapTo = document.getElementById('swapTo');
    const swapDate = document.getElementById('swapDate');
    const swapAskDate = document.getElementById('swapAskDate');
    const btnSwapOffer = document.getElementById('btnSwapOffer');
    const swapMsg = document.getElementById('swapMsg');

    const btnSubmitChecklist = document.getElementById('btnSubmitChecklist');
    const chkMsg = document.getElementById('chkMsg');

    const email = document.getElementById('email');
    const password = document.getElementById('password');

    const feed = document.getElementById('feed');
    const feedErr = document.getElementById('feedErr');
    const feedInfo = document.getElementById('feedInfo');

    // ---------- State ----------
    let currentUser = null;
    let currentProfile = null; // {uid, name, teamId, isAdmin}
    let unsubFeed = null;
    let allProfiles = []; // –¥–ª—è –∞–¥–º–∏–Ω–∞

    // ---------- Helpers ----------
    const nowMs = () => Date.now();
    const fmtDate = (ts) => {
      try {
        if (!ts) return '‚Äî';
        if (typeof ts.toDate === 'function') return ts.toDate().toLocaleString();
        return new Date(ts).toLocaleString();
      } catch { return '‚Äî'; }
    };
    const el = (html) => {
      const d = document.createElement('div'); d.innerHTML = html.trim(); return d.firstChild;
    };
    const setHidden = (node, hidden) => node.classList.toggle('hidden', hidden);

    // ---------- Auth UI ----------
    btnSignIn.onclick = async () => {
      authMsg.textContent = '';
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
      } catch (e) { authMsg.textContent = e.message; }
    };
    btnRegister.onclick = async () => {
      authMsg.textContent = '';
      try {
        const cred = await createUserWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
        // —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        await setDoc(doc(db, 'profiles', cred.user.uid), {
          uid: cred.user.uid,
          name: cred.user.email.split('@')[0],
          teamId: 'unknown',
          isAdmin: false,
          createdAt: serverTimestamp()
        });
      } catch (e) { authMsg.textContent = e.message; }
    };
    btnSignOut.onclick = async () => { await signOut(auth); };

    // ---------- Profiles cache for admin ----------
    async function loadAllProfiles() {
      // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ REST getDoc –Ω–µ–ª—å–∑—è; —Ç—É—Ç –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –≤—ã–±–µ—Ä–µ–º –ø–æ id, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã.
      // –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–Ω–¥–µ–∫—Å–∞ –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –≤—ã–≤–æ–¥.
      // –î–ª—è –¥–µ–º–æ –º—ã –ø–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å —Å–∞–º—ã—Ö –Ω—É–∂–Ω—ã—Ö ‚Äî —Ç–µ–∫—É—â–µ–≥–æ –∏ –∞–¥—Ä–µ—Å–∞—Ç–æ–≤ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ UI.
      // (–£–ø—Ä–æ—Å—Ç–∏–º: –∑–∞–ø–æ–ª–Ω–∏–º select —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π —Å–ø–æ—Å–æ–±.)
      allProfiles = [currentProfile].filter(Boolean);
      // –í—ã –º–æ–∂–µ—Ç–µ —Å–∞–º–∏ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å options –Ω—É–∂–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏:
      postAsSelect.innerHTML = '<option value="">‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>';
      for (const p of allProfiles) {
        const opt = document.createElement('option');
        opt.value = p.uid;
        opt.textContent = `${p.name} (${p.teamId})`;
        postAsSelect.appendChild(opt);
      }
    }

    // ---------- Current profile ----------
    async function fetchProfile(uid) {
      const snap = await getDoc(doc(db, 'profiles', uid));
      if (!snap.exists()) return null;
      const data = snap.data();
      return {
        uid,
        name: data.name || '(no-name)',
        teamId: data.teamId || 'unknown',
        isAdmin: !!data.isAdmin
      };
    }

    function renderWhoAmI() {
      if (!currentUser) {
        whoami.textContent = '‚Äî';
        setHidden(chipAdmin, true);
        setHidden(chipTeam, true);
        setHidden(adminBox, true);
        btnSignOut.disabled = true;
        return;
      }
      whoami.textContent = `${currentUser.email} ${currentProfile ? `‚Äî ${currentProfile.name}` : ''}`;
      btnSignOut.disabled = false;
      if (currentProfile) {
        chipTeam.textContent = currentProfile.teamId;
        setHidden(chipTeam, false);
        setHidden(chipAdmin, !currentProfile.isAdmin);
        setHidden(adminBox, !currentProfile.isAdmin);
      }
    }

    // ---------- Messages feed ----------
    function unsubscribeFeed() { if (unsubFeed) { unsubFeed(); unsubFeed = null; } }

    function subscribeFeedForUser() {
      if (!currentProfile) return;
      unsubFeed && unsubFeed();

      // –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–¥–µ –µ–≥–æ teamId –≤ visibleTeamIds
      const q = query(
        collectionGroup(db, 'messages'),
        where('visibleTeamIds', 'array-contains', currentProfile.teamId),
        orderBy('createdAt', 'desc'),
        limit(100)
      );

      feedInfo.textContent = `–§–∏–ª—å—Ç—Ä: teamId=${currentProfile.teamId}`;
      feedErr.textContent = '';
      unsubFeed = onSnapshot(q, (snap) => {
        renderFeed(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      }, (err) => {
        console.error('messages(user) onSnapshot error', err);
        feedErr.textContent = `messages(user) error: ${err.message}`;
      });
    }

    function subscribeFeedForAdmin() {
      if (!currentProfile || !currentProfile.isAdmin) return;
      unsubFeed && unsubFeed();

      // –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å—ë
      const q = query(
        collectionGroup(db, 'messages'),
        orderBy('createdAt', 'desc'),
        limit(200)
      );

      feedInfo.textContent = '–§–∏–ª—å—Ç—Ä: admin (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è)';
      feedErr.textContent = '';
      unsubFeed = onSnapshot(q, (snap) => {
        renderFeed(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      }, (err) => {
        console.error('messages(admin) onSnapshot error', err);
        feedErr.textContent = `messages(admin) error: ${err.message}`;
      });
    }

    function renderFeed(items) {
      feed.innerHTML = '';
      if (!items.length) {
        feed.appendChild(el(`<div class="meta">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç</div>`));
        return;
      }
      for (const m of items) {
        if (m.status && m.status === 'cancelled') continue; // —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ swap'—ã

        const resolved = !!m.resolvedAt;
        const row = el(`<div class="card ${resolved ? 'resolved' : ''}">
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:start;">
            <div>
              <div><b>${escapeHtml(m.kind || 'user')}</b></div>
              <div class="meta">
                <span>at: ${fmtDate(m.createdAt)}</span>
                ${m.authorName ? `<span>by: ${escapeHtml(m.authorName)}</span>` : ''}
                ${m.authorTeamId ? `<span>team: ${escapeHtml(m.authorTeamId)}</span>` : ''}
                ${m.postedByAdmin ? `<span class="tag">posted by admin</span>` : ''}
              </div>
            </div>
            <div class="chips">
              ${resolved ? `<span class="tag">resolved</span>` : ''}
              ${m.kind === 'swap_offer' && m.meta
                ? `<span class="tag">from: ${escapeHtml(m.meta.from)}</span>
                   <span class="tag">to: ${escapeHtml(m.meta.to)}</span>`
                : ''}
            </div>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(m.text || '')}</div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn btn-resolve">Mark resolved</button>
            ${currentProfile?.isAdmin || currentUser?.uid === m.authorId ? `<button class="btn btn-delete">Delete</button>` : ''}
          </div>
        </div>`);

        row.querySelector('.btn-resolve').onclick = () => markResolved(m);
        const delBtn = row.querySelector('.btn-delete');
        if (delBtn) delBtn.onclick = () => deleteMessage(m);
        feed.appendChild(row);
      }
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    // ---------- Publish controls ----------
    msgText.addEventListener('input', () => {
      btnPublish.disabled = msgText.value.trim().length === 0;
    });

    btnPublish.onclick = async () => {
      pubMsg.textContent = '';
      try {
        await publishUserMessage(msgText.value.trim());
        msgText.value = '';
        btnPublish.disabled = true;
        pubMsg.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
        setTimeout(() => pubMsg.textContent = '', 1500);
      } catch (e) {
        pubMsg.textContent = e.message;
      }
    };

    async function publishUserMessage(text) {
      if (!currentUser || !currentProfile) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      const postAsUid = postAsSelect.value; // –µ—Å–ª–∏ –∞–¥–º–∏–Ω –≤—ã–±—Ä–∞–ª "–æ—Ç –∏–º–µ–Ω–∏"
      let author = currentProfile;

      if (currentProfile.isAdmin && postAsUid) {
        // –ø—É–±–ª–∏–∫—É–µ–º –æ—Ç –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
        const ap = allProfiles.find(p => p.uid === postAsUid) || await fetchProfile(postAsUid);
        if (!ap) throw new Error('–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        author = ap;
      }

      const path = ['teams', author.teamId, 'messages']; // –ø—Ä–∏–º–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      const ref = collection(db, ...path);

      const docData = {
        kind: 'user',
        text,
        createdAt: serverTimestamp(),
        createdAtMs: nowMs(),

        // "—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π" –∞–≤—Ç–æ—Ä
        authorId: author.uid,
        authorName: author.name,
        authorTeamId: author.teamId,

        // –∫—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Å—Ç–∏—Ç
        postedByAdmin: currentProfile.isAdmin && !!postAsUid,
        postedByAdminId: currentUser.uid,
        postedByAdminName: currentProfile.name,

        // –≤–∏–¥–∏–º–æ—Å—Ç—å
        visibleTeamIds: [author.teamId],

        meta: {},
        resolvedAt: null
      };

      await addDoc(ref, docData);
    }

    // ---------- Swap offer ----------
    btnSwapOffer.onclick = async () => {
      swapMsg.textContent = '';
      try {
        await sendSwapOffer({
          from: swapFrom.value.trim(),
          to: swapTo.value.trim(),
          date: swapDate.value,
          askDate: swapAskDate.value
        });
        swapMsg.textContent = 'Swap offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
        setTimeout(() => swapMsg.textContent = '', 1500);
      } catch (e) {
        swapMsg.textContent = e.message;
      }
    };

    async function sendSwapOffer({ from, to, date, askDate }) {
      if (!currentUser || !currentProfile) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');

      if (!from || !to || !date || !askDate) throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è swap');
      // –ê–≤—Ç–æ—Ä –ø–æ —Å–º—ã—Å–ª—É ‚Äî —Ç–æ—Ç, –æ—Ç —á—å–µ–≥–æ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
      let author = currentProfile;
      const postAsUid = currentProfile.isAdmin ? postAsSelect.value : '';
      if (currentProfile.isAdmin && postAsUid) {
        const ap = allProfiles.find(p => p.uid === postAsUid) || await fetchProfile(postAsUid);
        if (!ap) throw new Error('–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        author = ap;
      }

      // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const text = `üîÅ Swap offer: ${author.name} proposes exchange ${date} ‚áÑ ${askDate}`;

      // –†–∞–∑–º–µ—â–∞–µ–º –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è –≤–∞—Å –º–µ—Å—Ç–µ; –≤–∞–∂–Ω–æ —á—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "messages"
      const ref = collection(db, 'teams', from, 'messages');

      const docData = {
        kind: 'swap_offer',
        text,
        createdAt: serverTimestamp(),
        createdAtMs: nowMs(),

        authorId: author.uid,
        authorName: author.name,
        authorTeamId: author.teamId,

        postedByAdmin: currentProfile.isAdmin && !!postAsUid,
        postedByAdminId: currentUser.uid,
        postedByAdminName: currentProfile.name,

        // –í–ê–ñ–ù–û: –æ–±–µ –∫–æ–º–∞–Ω–¥—ã –≤ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        visibleTeamIds: Array.from(new Set([from, to])),

        meta: { from, to, date, askDate },
        status: 'open',       // open | accepted | declined | counter | cancelled
        resolvedAt: null
      };

      await addDoc(ref, docData);
    }

    // ---------- Checklist ----------
    btnSubmitChecklist.onclick = async () => {
      chkMsg.textContent = '';
      try {
        const all = [...document.querySelectorAll('.chk')];
        const allChecked = all.every(c => c.checked);
        if (!allChecked) throw new Error('–û—Ç–º–µ—Ç—å—Ç–µ –≤—Å–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞');

        await publishChecklistSubmitted();
        chkMsg.textContent = 'Checklist –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç';
        setTimeout(() => chkMsg.textContent = '', 1500);
      } catch (e) {
        chkMsg.textContent = e.message;
      }
    };

    async function publishChecklistSubmitted() {
      if (!currentUser || !currentProfile) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');

      let author = currentProfile;
      const postAsUid = currentProfile.isAdmin ? postAsSelect.value : '';
      if (currentProfile.isAdmin && postAsUid) {
        const ap = allProfiles.find(p => p.uid === postAsUid) || await fetchProfile(postAsUid);
        if (!ap) throw new Error('–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        author = ap;
      }

      const ref = collection(db, 'teams', author.teamId, 'messages');

      const docData = {
        kind: 'checklist_submitted',
        text: '‚úÖ Checklist submitted',
        createdAt: serverTimestamp(),
        createdAtMs: nowMs(),

        authorId: author.uid,
        authorName: author.name,
        authorTeamId: author.teamId,

        postedByAdmin: currentProfile.isAdmin && !!postAsUid,
        postedByAdminId: currentUser.uid,
        postedByAdminName: currentProfile.name,

        visibleTeamIds: [author.teamId],
        meta: {},
        resolvedAt: null
      };

      await addDoc(ref, docData);
    }

    // ---------- Mutations ----------
    async function markResolved(m) {
      try {
        const refPath = m._refPath || guessRefPath(m);
        if (!refPath) throw new Error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞');
        await updateDoc(doc(db, ...refPath), { resolvedAt: serverTimestamp() });
      } catch (e) {
        alert('Mark resolved error: ' + e.message);
      }
    }

    async function deleteMessage(m) {
      try {
        const refPath = m._refPath || guessRefPath(m);
        if (!refPath) throw new Error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞');
        // –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
        await updateDoc(doc(db, ...refPath), { status: 'cancelled' });
      } catch (e) {
        alert('Delete error: ' + e.message);
      }
    }

    // NOTE: –∫–æ–≥–¥–∞ —Å–ª—É—à–∞–µ–º collectionGroup, Firebase –Ω–µ –æ—Ç–¥–∞—ë—Ç –Ω–∞–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å.
    // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± ¬´—É–≥–∞–¥–∞—Ç—å¬ª ‚Äî –µ—Å–ª–∏ –º—ã –∂–µ—Å—Ç–∫–æ –∑–Ω–∞–µ–º —Å—Ö–µ–º—É `teams/{teamId}/messages/{id}`:
    function guessRefPath(m) {
      const teamId = m.authorTeamId || (currentProfile?.teamId ?? null);
      if (!teamId) return null;
      // –í collectionGroup –Ω–µ—Ç info –æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏-—Ä–æ–¥–∏—Ç–µ–ª–µ; –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ª–µ–∂–∏—Ç –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥–µ, —ç—Ç–æ—Ç –ø—É—Ç—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.
      // –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ `_parentPath` –≤ —Å–∞–º–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏.
      return ['teams', teamId, 'messages', m.id];
    }

    // ---------- Auth state ----------
    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      unsubscribeFeed();
      if (!currentUser) {
        currentProfile = null;
        renderWhoAmI();
        feed.innerHTML = '';
        feedInfo.textContent = '‚Äî';
        postAsSelect.value = '';
        setHidden(adminBox, true);
        return;
      }
      currentProfile = await fetchProfile(currentUser.uid);
      renderWhoAmI();

      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å "post as" (–º–∏–Ω–∏–º—É–º ‚Äî —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å; –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
      await loadAllProfiles();

      // –ü–æ–¥–ø–∏—Å–∫–∞: –µ—Å–ª–∏ –∞–¥–º–∏–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ; –∏–Ω–∞—á–µ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–µ
      if (currentProfile.isAdmin) subscribeFeedForAdmin();
      else subscribeFeedForUser();
    });

    // –°–±—Ä–æ—Å "post as" –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∞
    postAsSelect.addEventListener('change', () => {
      postAsHint.textContent = postAsSelect.value
        ? '–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –æ—Ç –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è'
        : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –æ—Ç –≤–∞—à–µ–≥–æ –∏–º–µ–Ω–∏ (–∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).';
    });
  </script>
</body>
</html>
