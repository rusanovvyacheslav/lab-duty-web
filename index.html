<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>lab-duty</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="max-w-3xl mx-auto p-4">
  <h1 class="text-2xl font-semibold mb-4">lab-duty</h1>

  <div id="whoami" class="mb-4 text-sm text-slate-600">—</div>

  <section class="mb-6">
    <h2 class="font-semibold mb-2">Post a message</h2>
    <textarea id="msgText" class="w-full border rounded p-2" rows="3" placeholder="Write a short update…"></textarea>
    <button id="btnPublish" class="mt-2 px-3 py-1.5 border rounded">Publish</button>
  </section>

  <section>
    <h2 class="font-semibold mb-2">Messages</h2>
    <div id="feed" class="space-y-3"></div>
  </section>

  <script type="module">
    // 1) Firebase init
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAIG0xtx8GrdTYC7wVvpG74hB8ILvDnsgA",
      authDomain: "lab-duty-micro.firebaseapp.com",
      projectId: "lab-duty-micro",
      storageBucket: "lab-duty-micro.firebasestorage.app",
      messagingSenderId: "1033748176559",
      appId: "1:1033748176559:web:75faef74de0023cc807e5a",
      measurementId: "G-K6RPGETF8B"
    };

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 2) Anonymous sign-in
    onAuthStateChanged(auth, async (u) => {
      if (!u) await signInAnonymously(auth);
      document.getElementById('whoami').textContent = u ? `Signed in: ${u.uid.slice(0,8)}…` : '—';
    });

    // 3) Publish message (без картинок)
    document.getElementById('btnPublish').addEventListener('click', async ()=>{
      const text = document.getElementById('msgText').value.trim();
      if(!text) return alert('Empty');
      const u = auth.currentUser;
      try{
        await addDoc(collection(db,'messages'), {
          text,
          attachments: [],               // без фото
          createdAt: serverTimestamp(),
          resolvedAt: null,
          authorId: u?.uid || 'anon',
          authorName: 'Anon',
          kind: 'user',
          meta: {}
        });
        document.getElementById('msgText').value = '';
      }catch(e){ console.error(e); alert('Failed to publish'); }
    });

    // 4) Realtime feed
    const feed = document.getElementById('feed');
    onSnapshot(query(collection(db,'messages'), orderBy('createdAt','desc')), (qs)=>{
      feed.innerHTML='';
      qs.forEach(s=>{
        const m = s.data(); const id = s.id;
        const card = document.createElement('div');
        card.className='border rounded p-3';
        card.innerHTML = `
          <div class="text-sm text-slate-500">${m.authorName||'Anon'}</div>
          <div class="mt-1 whitespace-pre-wrap">${m.text||''}</div>
          <div class="mt-2 flex gap-2">
            <button class="text-xs px-2 py-1 border rounded" data-id="${id}">Mark resolved</button>
          </div>`;
        card.querySelector('button').onclick = async ()=>{
          try{ await updateDoc(doc(db,'messages', id), { resolvedAt: new Date() }); }
          catch(e){ console.error(e); alert('Failed'); }
        };
        feed.appendChild(card);
      });
    });
  </script>
</body>
</html>
