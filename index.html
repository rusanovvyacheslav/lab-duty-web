<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lab-duty</title>
  <!-- CDN Tailwind — ок для dev. В проде лучше собрать PostCSS/CLI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .droptarget{ outline: 2px dashed rgba(100,116,139,0.5); outline-offset: -6px; }
    .holiday{ background-image: repeating-linear-gradient(45deg, rgba(100,116,139,.12) 0 10px, transparent 10px 20px); }
    @media print { .no-print{ display:none !important; } }

    .msg-swap{ background:#eff6ff; }
    .msg-swap-admin{ background:#eff6ff; border-color:#2563eb; }
    .msg-congrats{
      border:0 !important;
      background: linear-gradient(90deg,#ff9a9e,#fad0c4,#fbc2eb,#a1c4fd,#c2ffd8) !important;
      color:#111827 !important;
    }
    .msg-resolved{ background:#ecfdf5 !important; border-color:#10b981 !important; }

    .btn-disabled{ opacity:.5; pointer-events:none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-100 text-slate-800">

  <!-- HEADER -->
  <header class="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      <h1 class="text-xl font-semibold">lab-duty</h1>

      <div class="ml-auto flex items-center gap-2 no-print">
        <label id="labelIAm" class="text-xs text-slate-500">I am:</label>
        <select id="identitySelect" class="px-2 py-1.5 rounded-lg border bg-white text-sm min-w-[180px]"></select>
        <span id="whoami" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 border text-sm">—</span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
    <!-- LEFT -->
    <section class="col-span-12 lg:col-span-8">
      <div class="flex items-center gap-2 mb-3 no-print">
        <button id="prevMonth" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">← Prev</button>
        <div class="flex-1 text-center text-lg font-medium">
          <span id="monthTitle">—</span>
          <span class="mx-2 text-slate-400">•</span>
          <label class="text-sm text-slate-500">
            Span:
            <select id="spanSelect" class="border rounded px-2 py-1 text-sm">
              <option value="1">1 month</option>
              <option value="2">2 months</option>
              <option value="3">3 months</option>
              <option value="6">6 months</option>
            </select>
          </label>
        </div>
        <button id="nextMonth" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Next →</button>
      </div>

      <div class="flex items-center gap-3 mb-4 text-sm no-print">
        <label class="inline-flex items-center gap-2"><input id="toggleSwap" type="checkbox" class="rounded"/> Show swap-needed only</label>
        <button id="btnExportCSV" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Export CSV</button>
        <button id="btnPrint" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">Print</button>
      </div>

      <div id="calWrap" class="space-y-6"></div>

      <p class="text-xs text-slate-500 mt-4 flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-amber-400"></span>
        Days needing swap are highlighted. Click your own chip to toggle “need swap”.
        <span class="ml-4 inline-block w-2 h-2 rounded-full bg-slate-300"></span>
        Grey cells are public holidays (editable in code).
      </p>
    </section>

    <!-- RIGHT -->
    <aside class="col-span-12 lg:col-span-4 space-y-6">
      <div id="teamPanel" class="rounded-2xl border bg-white p-4 hidden">
        <div class="flex items-center gap-2 mb-2">
          <h2 class="font-semibold">Team</h2>
          <span id="adminBadge" class="ml-auto text-[11px] px-2 py-0.5 rounded-full border">Admin</span>
        </div>
        <p class="text-xs text-slate-500 mb-3">Drag names onto a day (admin only). Click × on a chip to remove.</p>
        <div id="teamChips" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="rounded-2xl border bg-white p-4">
        <h2 class="font-semibold mb-2">Supplies checklist</h2>
        <p id="checklistInfo" class="text-xs text-slate-500 mb-3"></p>
        <div id="checklist" class="space-y-1"></div>
        <button id="btnDone" class="mt-3 w-full px-3 py-2 rounded-lg border hover:bg-slate-50 hidden">I’m done for today ✅</button>
      </div>

      <div class="rounded-2xl border bg-white p-4">
        <div class="flex items-center gap-2 mb-2">
          <h2 class="font-semibold">Messages</h2>
        </div>
        <textarea id="msgText" class="w-full border rounded-lg p-2 text-sm" rows="3" placeholder="Write a short update… (swap needed, broken device, etc.)"></textarea>
        <button id="btnPublish" disabled class="mt-2 w-full px-3 py-2 rounded-lg border hover:bg-slate-50">Publish</button>
        <hr class="my-3"/>
        <div id="feed" class="space-y-3"></div>
      </div>
    </aside>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-slate-500">
    Single-file app. Firebase Auth (anonymous) + Firestore. No Storage. v6.0
  </footer>

  <!-- MODAL -->
  <div id="dateModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-2xl border bg-white shadow-xl">
        <div class="p-4 border-b flex items-center gap-2">
          <h3 id="dm_title" class="text-base font-semibold">Choose a date</h3>
          <button id="dm_close" class="ml-auto rounded-lg border px-2 py-1 text-sm hover:bg-slate-50">✕</button>
        </div>
        <div class="px-4 pt-3">
          <div id="dm_tabs" class="flex gap-2 mb-3 hidden">
            <button id="dm_tab_my" class="px-3 py-1.5 rounded-lg border text-sm bg-slate-900 text-white">My dates</button>
            <button id="dm_tab_their" class="px-3 py-1.5 rounded-lg border text-sm">Their dates</button>
          </div>
          <div id="dm_list" class="max-h-80 overflow-auto space-y-1"></div>
          <p id="dm_hint" class="text-xs text-slate-500 mt-2"></p>
        </div>
        <div class="p-4 border-t flex items-center gap-2">
          <button id="dm_cancel" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Cancel</button>
          <button id="dm_ok" class="ml-auto px-3 py-2 rounded-lg border hover:bg-slate-50 disabled:opacity-50" disabled>Select</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <script type="module">
    /******** 0) CONFIG ********/
    const TEAM = [
      { id: 'slava', name: 'Slava' },
      { id: 'vanina', name: 'Vanina' },
      { id: 'helene', name: 'Helene' },
      { id: 'eva', name: 'Eva' },
      { id: 'guillaume', name: 'Guillaume' },
      { id: 'gaetan', name: 'Gaetan' },
      { id: 'mathieu', name: 'Mathieu' },
      { id: 'luc', name: 'Luc' },
      { id: 'elise', name: 'Elise' },
      { id: 'jia', name: 'Jia' },
    ];

    const ADMIN_ID = 'admin';
    const ADMIN_LABEL = 'Administrator';

    const HOLIDAYS = {
      '2025-01-01':'New Year','2025-04-21':'Easter Monday','2025-05-01':'Labour Day','2025-05-08':'Victory in Europe Day','2025-05-29':'Ascension Day','2025-06-09':'Whit Monday','2025-07-14':'Bastille Day','2025-08-15':'Assumption','2025-11-01':'All Saints’ Day','2025-11-11':'Armistice Day','2025-12-25':'Christmas',
      '2026-01-01':'New Year','2026-04-06':'Easter Monday','2026-05-01':'Labour Day','2026-05-08':'Victory in Europe Day','2026-05-14':'Ascension Day','2026-05-25':'Whit Monday','2026-07-14':'Bastille Day','2026-08-15':'Assumption','2026-11-01':'All Saints’ Day','2026-11-11':'Armistice Day','2026-12-25':'Christmas'
    };

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAIG0xtx8GrdTYC7wVvpG74hB8ILvDnsgA",
      authDomain: "lab-duty-micro.firebaseapp.com",
      projectId: "lab-duty-micro",
      storageBucket: "lab-duty-micro.firebasestorage.app",
      messagingSenderId: "1033748176559",
      appId: "1:1033748176559:web:75faef74de0023cc807e5a",
      measurementId: "G-K6RPGETF8B"
    };

    const CHECKITEMS = [
      { id:'benches', label:'Wipe benches' },
      { id:'trash', label:'Empty trash (non-bio)' },
      { id:'biohaz', label:'Biohazard bin' },
      { id:'floor', label:'Sweep/mop floor' },
      { id:'hoods', label:'Clean biosafety hoods surfaces' },
      { id:'incub', label:'Check CO₂ incubator trays' },
      { id:'stock', label:'Refill towels/soap/ethanol' },
    ];

    /******** 1) Firebase ********/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /******** 2) Helpers ********/
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const esc = (s)=> (s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    const toKey = (d) => { const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; };
    const fromKey = (k) => { const [y,m,dd]=k.split('-').map(Number); return new Date(y,m-1,dd); };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const startOfMonth = (d)=> new Date(d.getFullYear(), d.getMonth(), 1);
    const endOfMonth   = (d)=> new Date(d.getFullYear(), d.getMonth()+1, 0);
    function monthBounds(d, span=1){ const a = new Date(d.getFullYear(), d.getMonth(), 1); const b = new Date(d.getFullYear(), d.getMonth()+span, 0); return [a,b]; }
    function gridRangeWeekdays(cursor){
      const start = startOfMonth(cursor), end = endOfMonth(cursor);
      const s = addDays(start, -((start.getDay()+6)%7)); const e = addDays(end, (5 - ((end.getDay()+6)%7) + 7)%7);
      const days=[]; let cur=new Date(s); while(cur<=e){ const dow=(cur.getDay()+6)%7; if(dow<5) days.push(new Date(cur)); cur=addDays(cur,1); }
      return { days, start, end };
    }
    const nameById = (id)=> id===ADMIN_ID? ADMIN_LABEL : (TEAM.find(t=>t.id===id)?.name || null);
    const isHolidayKey = (k)=> !!HOLIDAYS[k];

    /******** 3) State ********/
    let cursor = startOfMonth(new Date());
    let spanMonths = 1;

    // Выбор пользователя (teamId) сохраняем локально. Админ — «отдельный профиль» (uid с isAdmin:true), поэтому teamId может быть null.
    let meId = localStorage.getItem('labduty_meId') || null;

    // Источник истины — профиль из Firestore
    let currentProfile = { teamId: null, isAdmin: false };

    const daysMap = {};
    let rangeUnsub = null;

    let unsubPublic=null, unsubPrivOffer=null, unsubPrivCounter=null, unsubAdminAll=null;
    const commentUnsubs = {};
    let messagesCache = {};

    async function ensureAnon(){ if(!auth.currentUser) await signInAnonymously(auth); }

    /******** 4) Profiles (isAdmin только читаем) ********/
    async function saveMyProfileTeam(){
      await ensureAnon();
      const u = auth.currentUser; if(!u) return;
      const data = {};
      if(typeof meId === 'string' && meId.trim()){ data.teamId = meId.trim(); }
      // ВАЖНО: из клиента НЕЛЬЗЯ менять isAdmin
      if(Object.keys(data).length>0) await setDoc(doc(db,'profiles', u.uid), data, { merge:true });
    }

    function subscribeProfile(){
      const u = auth.currentUser; if(!u) return;
      return onSnapshot(doc(db,'profiles',u.uid), (snap)=>{
        const data = snap.data()||{};
        currentProfile = { teamId: data.teamId||null, isAdmin: !!data.isAdmin };
        renderHeader();
        // если профайл изменился (получили isAdmin), перевешиваем подписки
        resubscribeMessages();
        renderChecklist();
        paintAll();
      }, (err)=> console.error('profile onSnapshot error', err));
    }

    async function ensureProfileTeamReady(){
      if(!meId) return true;
      await ensureAnon();
      const u = auth.currentUser; if(!u) return false;
      await setDoc(doc(db,'profiles',u.uid), { teamId: meId }, { merge:true });
      const snap = await getDoc(doc(db,'profiles',u.uid));
      return (snap.data()?.teamId === meId);
    }

    /******** 5) Identity/Admin UI ********/
    async function setMe(id){
      if(id===ADMIN_ID){
        // Админ — это отдельный профиль (uid) с isAdmin:true, выставленный в консоли.
        // Здесь просто переключаемся в режим «без teamId».
        meId = null;
        localStorage.removeItem('labduty_meId');
        await saveMyProfileTeam(); // сохранит teamId=null (не трогаем isAdmin)
      }else{
        meId = id || null;
        if(meId) localStorage.setItem('labduty_meId',meId); else localStorage.removeItem('labduty_meId');
        await saveMyProfileTeam();
      }
      renderHeader();
      await resubscribeMessages();
      renderChecklist();
      paintAll();
    }

    function renderHeader(){
      const sel = $('#identitySelect');
      sel.innerHTML = '<option value="">&mdash; choose &mdash;</option>'
        + TEAM.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')
        + `<option value="${ADMIN_ID}">${ADMIN_LABEL}</option>`;
      const adminOK = !!currentProfile.isAdmin;
      sel.value = meId || (adminOK? ADMIN_ID : '');
      $('#whoami').textContent = adminOK ? (ADMIN_LABEL+' ✓') : (meId ? (nameById(meId)+ ' ✓') : '—');

      $('#teamPanel').classList.toggle('hidden', !adminOK);
      $('#identitySelect').classList.remove('hidden');
      $('#labelIAm').classList.remove('hidden');

      renderTeamChips();
      paintAll();
    }
    $('#identitySelect').addEventListener('change', (e)=> setMe(e.target.value || null));

    function renderTeamChips(){
      const box = $('#teamChips'); box.innerHTML='';
      const adminOK = !!currentProfile.isAdmin;
      TEAM.forEach(t=>{
        const el = document.createElement('div');
        el.className='inline-flex items-center gap-2 px-3 py-1 rounded-full border bg:white bg-white text-sm';
        el.textContent=t.name; el.draggable = adminOK;
        el.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', t.id); });
        box.appendChild(el);
      });
    }

    /******** 6) Days ********/
    function rangeKeyBounds(d, span){ const [a,b] = monthBounds(d, span); return [toKey(a), toKey(b)]; }

    function subscribeRange(){
      if(rangeUnsub) rangeUnsub();
      const [a,b] = rangeKeyBounds(cursor, spanMonths);
      const qy = query(collection(db,'days'), where('date','>=',a), where('date','<=',b), orderBy('date','asc'));
      rangeUnsub = onSnapshot(qy, (qs)=>{
        qs.forEach(docSnap=>{ const d = migrateDay(docSnap.data()); daysMap[docSnap.id] = d; });
        renderCalendar(); renderChecklist();
      }, (err)=>{ console.error('days onSnapshot error', err); });
    }

    function migrateDay(d){
      if(!d) return null;
      const out = { date:d.date, assignees:[], swapRequestedIds:[], note:d.note||'', checklist:d.checklist||{}, doneAt:d.doneAt||null, updatedAt:d.updatedAt||null };
      if(Array.isArray(d.assignees)) out.assignees = d.assignees; else if(d.assigneeId) out.assignees = d.assigneeId ? [d.assigneeId] : [];
      if(Array.isArray(d.swapRequestedIds)) out.swapRequestedIds = d.swapRequestedIds; else if(d.swapRequested) out.swapRequestedIds = d.assigneeId ? [d.assigneeId] : [];
      return out;
    }

    async function setAssignees(dayKey, ids){
      const ref = doc(db,'days',dayKey);
      const snap = await getDoc(ref);
      const base = snap.exists()? migrateDay(snap.data()) : { date:dayKey, assignees:[], swapRequestedIds:[], note:'', checklist:{} };
      const newSwaps = (base.swapRequestedIds||[]).filter(x=> ids.includes(x));
      await setDoc(ref, { ...base, assignees: ids, swapRequestedIds: newSwaps, updatedAt: serverTimestamp() });
    }

    async function toggleSwap(dayKey, whoId){
      const ref = doc(db,'days',dayKey);
      const snap = await getDoc(ref); if(!snap.exists()) return;
      const d = migrateDay(snap.data());
      const set = new Set(d.swapRequestedIds);
      const wasSet = set.has(whoId);
      if(set.has(whoId)) set.delete(whoId); else set.add(whoId);
      await updateDoc(ref, { swapRequestedIds:[...set], updatedAt: serverTimestamp() });
      if(wasSet){ await resolvePendingSwapMessages(dayKey, whoId); }
    }

    async function saveChecklist(todayKey, checklist){
      const ref = doc(db,'days',todayKey);
      const snap = await getDoc(ref);
      const base = snap.exists()? migrateDay(snap.data()) : { date:todayKey, assignees:[], swapRequestedIds:[], note:'', checklist:{} };
      await setDoc(ref,{ ...base, checklist, updatedAt: serverTimestamp() });
    }

    async function markDone(todayKey){
      const ref = doc(db,'days',todayKey);
      const snap = await getDoc(ref);
      const base = snap.exists()? migrateDay(snap.data()) : { date:todayKey, assignees:[], swapRequestedIds:[], note:'', checklist:{} };
      await setDoc(ref,{ ...base, doneAt: serverTimestamp(), updatedAt: serverTimestamp() });
    }

    /******** 7) Messages ********/
    function clearMessageSubs(){
      if(unsubPublic){ try{unsubPublic();}catch(_){} unsubPublic=null; }
      if(unsubPrivOffer){ try{unsubPrivOffer();}catch(_){} unsubPrivOffer=null; }
      if(unsubPrivCounter){ try{unsubPrivCounter();}catch(_){} unsubPrivCounter=null; }
      if(unsubAdminAll){ try{unsubAdminAll();}catch(_){} unsubAdminAll=null; }
      Object.values(commentUnsubs).forEach(u=>{try{u();}catch(_){}}); for(const k in commentUnsubs) delete commentUnsubs[k];
      messagesCache={};
      $('#feed').innerHTML='';
    }

    function mergeAndRender(){
      const feed=$('#feed');
      const items = Object.entries(messagesCache).map(([id,m])=>({id,m}));
      items.sort((a,b)=>{
        const ta=(a.m.createdAtMs??0)||(a.m.createdAt?.toMillis?.()||0);
        const tb=(b.m.createdAtMs??0)||(b.m.createdAt?.toMillis?.()||0);
        return tb-ta;
      });
      feed.innerHTML='';
      items.forEach(({id,m})=> renderMessageCard(id,m));
    }

    async function resubscribeMessages(){
      await ensureAnon();
      clearMessageSubs();

      const adminOK = !!currentProfile.isAdmin;

      if(adminOK){
        // Админ видит всё
        const qAll=query(collection(db,'messages'), orderBy('createdAt','desc'));
        unsubAdminAll = onSnapshot(qAll,(qs)=>{
          qs.forEach(ds=>{ messagesCache[ds.id]=ds.data(); });
          mergeAndRender();
        },err=>console.error('messages(admin) error',err));
        return;
      }

      // Публичные (user/system)
      const qPublic=query(collection(db,'messages'), where('kind','in',['user','system']));
      unsubPublic = onSnapshot(qPublic,(qs)=>{
        qs.forEach(ds=>{ messagesCache[ds.id]=ds.data(); });
        mergeAndRender();
      },err=>console.error('messages(public) error',err));

      // Приватные свопы — только после готовности профиля с teamId
      if(meId){
        const ok = await ensureProfileTeamReady();
        if(!ok){
          console.warn('Profile teamId not ready yet; retry later');
          return;
        }
        const qOffer=query(collection(db,'messages'), where('kind','==','swap_offer'), where('visibleTeamIds','array-contains', meId));
        unsubPrivOffer = onSnapshot(qOffer,(qs)=>{
          qs.forEach(ds=>{ messagesCache[ds.id]=ds.data(); });
          mergeAndRender();
        },err=>console.error('messages(offer) error',err));

        const qCounter=query(collection(db,'messages'), where('kind','==','swap_counter'), where('visibleTeamIds','array-contains', meId));
        unsubPrivCounter = onSnapshot(qCounter,(qs)=>{
          qs.forEach(ds=>{ messagesCache[ds.id]=ds.data(); });
          mergeAndRender();
        },err=>console.error('messages(counter) error',err));
      }
    }

    function renderMessageCard(id,m){
      const adminOK = !!currentProfile.isAdmin;

      // фильтр удалённых для неадмина
      if(!adminOK && m.deletedAt) return;

      const isSwap = (m.kind==='swap_offer' || m.kind==='swap_counter' || (m.kind==='system' && (m.meta?.type==='swap_accept' || m.meta?.type==='swap_done')));
      const isCongrats = (m.kind==='system' && m.meta?.type==='checklist_done');

      let card = document.getElementById('msg_'+id);
      if(!card){ card=document.createElement('div'); card.id='msg_'+id; $('#feed').appendChild(card); }
      card.className = 'rounded-xl border p-3 bg-white';
      if(isSwap) card.className += adminOK ? ' msg-swap msg-swap-admin border' : ' msg-swap';
      if(isCongrats) card.className = 'rounded-xl p-3 msg-congrats';
      if(m.resolvedAt && !m.deletedAt) card.className += ' msg-resolved';
      if(m.deletedAt) card.classList.add('opacity-60');

      const who = esc(m.authorName||'Anon');
      const headerRight = [];
      if(m.resolvedAt){ headerRight.push(`<span class='inline-flex items-center gap-1 px-1.5 py-0.5 rounded border'>Resolved: ${m.resolvedAt?.toDate? m.resolvedAt.toDate().toLocaleString():''}</span>`); }
      if(m.deletedAt){ headerRight.push(`<span class='inline-flex items-center gap-1 px-1.5 py-0.5 rounded border'>Deleted: ${m.deletedAt?.toDate? m.deletedAt.toDate().toLocaleString():''}</span>`); }
      const tsNum = (m.createdAtMs??0) || (m.createdAt?.toMillis?.()||0);
      headerRight.push(`<span>${tsNum? new Date(tsNum).toLocaleString() : ''}</span>`);

      card.innerHTML = `
        <div class="flex items-start gap-2">
          <div class="text-sm font-medium">${who}</div>
          <div class="ml-auto text-xs text-slate-600 flex items-center gap-2">${headerRight.join(' ')}</div>
        </div>
        <div class="mt-2 text-sm whitespace-pre-wrap">${esc(m.text||'')}</div>
        <div class="mt-2 flex items-center gap-2" id="actions_${id}">
          ${renderMessageButtonsHTML(m, id)}
        </div>
        <details class="mt-2" id="det_${id}">
          <summary class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50 inline">Comments</summary>
          <div class="mt-2 space-y-2" id="cm_${id}"></div>
          <div class="mt-2 flex items-center gap-2">
            <input class="flex-1 border rounded-lg px-2 py-1 text-sm" placeholder="Write a comment…" id="cmi_${id}">
            <button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="sendc" data-id="${id}">Send</button>
          </div>
        </details>
      `;

      wireMessageButtons(card, m, id);

      // Подписка на комментарии
      if (!commentUnsubs[id]) {
        const ref = collection(db, 'messages', id, 'comments');
        commentUnsubs[id] = onSnapshot(query(ref, orderBy('createdAt','asc')), (qs) => {
          const box = card.querySelector('#cm_' + id);
          if (!box) return;
          box.innerHTML = '';
          qs.forEach(ds => {
            const c = ds.data();
            const row = document.createElement('div');
            row.className = 'text-xs px-2 py-1 rounded-md border bg-slate-50';
            row.innerHTML = `<b>${esc(c.authorName||'Anon')}</b>: ${esc(c.text||'')}`;
            box.appendChild(row);
          });
        }, (err)=> console.error('comments error', err));
      }

      card.querySelector('button[data-act="sendc"]').onclick = async ()=>{
        const input = card.querySelector('#cmi_'+id); const text = input.value.trim(); if(!text) return;
        await ensureAnon();
        const u = auth.currentUser;
        try{
          await addDoc(collection(db,'messages', id, 'comments'), {
            text, createdAt: serverTimestamp(), createdAtMs: Date.now(),
            authorId: u?.uid||'anon', authorName: nameById(meId)|| (currentProfile.isAdmin? ADMIN_LABEL : 'Anon')
          }); input.value='';
        }catch(e){ console.error(e); alert('Failed'); }
      };
    }

    function renderMessageButtonsHTML(m, id){
      const adminOK = !!currentProfile.isAdmin;
      const resolved = !!m.resolvedAt, deleted = !!m.deletedAt;
      const parts = [];
      parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="resolve" data-id="${id}" ${resolved? 'disabled':''}>${resolved? 'Resolved ✓':'Mark resolved'}</button>`);
      if(adminOK){
        if(resolved){ parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="undo" data-id="${id}">Undo resolve</button>`); }
        if(!deleted){ parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="del" data-id="${id}">Delete</button>`); }
        if(deleted){ parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="restore" data-id="${id}">Restore</button>`); }
      }
      if(m.kind==='swap_offer' && meId){
        const toId = (m.meta?.to) || m.to;
        const isRecipient = toId === meId;
        if((isRecipient || currentProfile.isAdmin) && !m.deletedAt){
          parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="swap_accept" data-id="${id}">Accept offer</button>`);
          parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="swap_decline" data-id="${id}">Decline</button>`);
          parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="swap_counter" data-id="${id}">Propose different date</button>`);
        }
      }
      if(m.kind==='swap_counter' && meId){
        const toId = (m.meta?.to) || m.to;
        const isRecipient = toId === meId;
        if((isRecipient || currentProfile.isAdmin) && !m.deletedAt){
          parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="swap_accept_counter" data-id="${id}">Accept counter</button>`);
          parts.push(`<button class="text-xs px-2 py-1 rounded-md border hover:bg-slate-50" data-act="swap_decline" data-id="${id}">Decline</button>`);
        }
      }
      return parts.join('');
    }

    function wireMessageButtons(card, m, id){
      const btnResolve = card.querySelector('button[data-act="resolve"]');
      if(btnResolve) btnResolve.onclick = async ()=>{ try{ await ensureAnon(); await updateDoc(doc(db,'messages', id), { resolvedAt: serverTimestamp() }); }catch(e){ console.error(e); alert('Failed'); } };

      const bUndo = card.querySelector('button[data-act="undo"]');
      if(bUndo) bUndo.onclick = async ()=>{ try{ await ensureAnon(); await updateDoc(doc(db,'messages', id), { resolvedAt: null }); }catch(e){ console.error(e); alert('Failed'); } };

      const bDel = card.querySelector('button[data-act="del"]');
      if(bDel) bDel.onclick = async ()=>{ try{ await ensureAnon(); await updateDoc(doc(db,'messages', id), { deletedAt: serverTimestamp() }); }catch(e){ console.error(e); alert('Failed'); } };

      const bRes = card.querySelector('button[data-act="restore"]');
      if(bRes) bRes.onclick = async ()=>{ try{ await ensureAnon(); await updateDoc(doc(db,'messages', id), { deletedAt: null }); }catch(e){ console.error(e); alert('Failed'); } };

      const bAcc = card.querySelector('button[data-act="swap_accept"]');
      if(bAcc) bAcc.onclick = async ()=>{ try{
        await ensureAnon(); await applySwapOffer(m);
        await updateDoc(doc(db,'messages', id), { resolvedAt: serverTimestamp(), deletedAt: serverTimestamp() });
      }catch(e){ console.error(e); alert('Failed to accept'); } };

      const bDecl = card.querySelector('button[data-act="swap_decline"]');
      if(bDecl) bDecl.onclick = async ()=>{ try{
        await ensureAnon();
        await updateDoc(doc(db,'messages', id), { resolvedAt: serverTimestamp(), deletedAt: serverTimestamp() });
        await addSystemMsg(`❌ Swap offer declined.`, { ref:id }, m.meta?.from || m.from || meId);
      }catch(e){ console.error(e); alert('Failed'); } };

      const bCtr = card.querySelector('button[data-act="swap_counter"]');
      if(bCtr) bCtr.onclick = async ()=>{
        const myId = meId;
        const otherId = m.meta?.from || m.from;
        showDateModal({
          title: 'Propose a different date',
          mode: 'counter',
          fromId: myId,
          toId: otherId,
          onSelect: async (alt)=>{
            try{
              await ensureAnon();
              const u = auth.currentUser;
              await addDoc(collection(db,'messages'), {
                text:`🔁 Counter-offer: ${alt}`,
                createdAt: serverTimestamp(), createdAtMs: Date.now(),
                authorId: u?.uid||'anon',
                authorName: nameById(myId)||'Anon',
                kind:'swap_counter',
                meta:{ from: myId, to: otherId, date: m.meta?.date || m.date, askDate: alt },
                visibleTeamIds:[myId, otherId]
              });
            }catch(e){ console.error(e); alert('Failed'); }
          }
        });
      };

      const bAccCtr = card.querySelector('button[data-act="swap_accept_counter"]');
      if(bAccCtr) bAccCtr.onclick = async ()=>{ try{
        await ensureAnon(); await applySwapOffer(m);
        await updateDoc(doc(db,'messages', id), { resolvedAt: serverTimestamp(), deletedAt: serverTimestamp() });
      }catch(e){ console.error(e); alert('Failed'); } };
    }

    async function addSystemMsg(text, meta={}, authorTeamId=null){
      await ensureAnon();
      const u = auth.currentUser;
      await addDoc(collection(db,'messages'), {
        text, attachments: [], createdAt: serverTimestamp(), createdAtMs: Date.now(), resolvedAt: null,
        authorId: u?.uid||'anon', authorName: (authorTeamId? nameById(authorTeamId) : (currentProfile.isAdmin? ADMIN_LABEL : (nameById(meId)||'System'))),
        kind:'system', meta
      });
    }

    async function applySwapOffer(m){
      const meta = m.meta || m;
      const dayKey = meta?.date;
      const askDay = meta?.askDate || null;
      const from = meta?.from;
      const to = meta?.to;
      if(!dayKey || !from || !to) throw new Error('Bad offer meta');

      const dayRef = doc(db,'days', dayKey);
      const snap = await getDoc(dayRef); if(!snap.exists()) throw new Error('Day missing');
      const d = migrateDay(snap.data());
      const nextAssignees = (d.assignees||[]).map(x=> x===to? from : x);
      const nextSwaps = (d.swapRequestedIds||[]).filter(x=> x!==to);
      await setAssignees(dayKey, nextAssignees);
      await updateDoc(dayRef, { swapRequestedIds: nextSwaps, updatedAt: serverTimestamp() });

      if(askDay){
        const askRef = doc(db,'days', askDay);
        const askSnap = await getDoc(askRef); if(!askSnap.exists()) throw new Error('Ask day missing');
        const dd = migrateDay(askSnap.data());
        if(!(dd.assignees||[]).includes(from)) throw new Error('Volunteer not assigned on asked day');
        const ass2 = (dd.assignees||[]).map(x=> x===from? to : x);
        await setAssignees(askDay, ass2);
      }

      await addSystemMsg(
        askDay
          ? `✅ Swap accepted: ${nameById(from)} ↔ ${nameById(to)} ( ${dayKey} ⇄ ${askDay} )`
          : `✅ ${nameById(from)} covers ${dayKey} for ${nameById(to)}`,
        { type:'swap_done', date: dayKey, askDate: askDay, from, to },
        from
      );
    }

    async function resolvePendingSwapMessages(dateKey,teamId){
      const entries=Object.entries(messagesCache);
      const toClose=entries.filter(([id,m])=> m && (m.kind==='swap_offer'||m.kind==='swap_counter')
        && !m.resolvedAt && !m.deletedAt
        && ((m.meta?.date||m.date)===dateKey)
        && ((m.meta?.from||m.from)===teamId || (m.meta?.to||m.to)===teamId) );
      for(const [id,_m] of toClose){
        try{ await updateDoc(doc(db,'messages',id), {resolvedAt:serverTimestamp(),deletedAt:serverTimestamp()}); }
        catch(e){ console.error('resolvePendingSwapMessages',e); }
      }
    }

    /******** 8) Calendar UI ********/
    function renderMonthBlock(baseDate){
      const month = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
      const { days } = gridRangeWeekdays(month);

      const block = document.createElement('section'); block.className = 'space-y-1';

      const wdays = document.createElement('div');
      wdays.className = 'grid grid-cols-5 text-center text-xs font-semibold text-slate-500';
      wdays.innerHTML = `<div class="py-2">Mon</div><div class="py-2">Tue</div><div class="py-2">Wed</div><div class="py-2">Thu</div><div class="py-2">Fri</div>`;
      const title = document.createElement('div');
      title.className = 'text-center text-lg font-medium my-1';
      title.textContent = month.toLocaleDateString(undefined,{ month:'long', year:'numeric' });

      const grid = document.createElement('div'); grid.className = 'grid grid-cols-5 gap-2';

      const todayK = toKey(new Date());
      days.forEach(d=>{
        const k = toKey(d), inMonth = d.getMonth()===month.getMonth(), isToday = k===todayK, isHoliday = isHolidayKey(k);
        const div = document.createElement('div');
        div.id = 'cell_'+k;
        div.className = [
          'rounded-2xl border p-2 min-h-[130px] flex flex-col gap-2 bg-white',
          !inMonth? 'opacity-60':'',
          isToday? 'ring-2 ring-slate-900':'',
          isHoliday? 'holiday':''
        ].join(' ');
        div.dataset.dayKey = k;
        div.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-medium flex items-center gap-2">
              <span>${d.getDate()}</span>
              ${isHoliday ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-200 border text-slate-700">${esc(HOLIDAYS[k]||'Holiday')}</span>` : ''}
            </div>
            <div id="badges_${k}" class="flex items-center gap-1"></div>
          </div>
          <div id="chips_${k}" class="flex flex-wrap gap-1"></div>
          <div id="actions_${k}" class="mt-auto pt-1 flex flex-wrap gap-1"></div>
        `;

        // DnD (admin only)
        div.addEventListener('dragover', (e)=>{ if(!currentProfile.isAdmin) return; e.preventDefault(); div.classList.add('droptarget'); });
        div.addEventListener('dragleave', ()=> div.classList.remove('droptarget'));
        div.addEventListener('drop', async (e)=>{
          if(!currentProfile.isAdmin) return; e.preventDefault(); div.classList.remove('droptarget');
          const whoId = e.dataTransfer.getData('text/plain'); if(!whoId) return;
          const cur = (daysMap[k]?.assignees)||[];
          if(!cur.includes(whoId)){
            daysMap[k] = daysMap[k]||{ date:k, assignees:[], swapRequestedIds:[], note:'', checklist:{} };
            daysMap[k].assignees = [...cur, whoId]; paintCell(k);
            try{ await setAssignees(k, daysMap[k].assignees); }catch(err){ alert('Save failed'); console.error(err); }
          }
        });

        grid.appendChild(div);
      });

      block.append(title, wdays, grid);
      return block;
    }

    function renderCalendar(){
      const calWrap = $('#calWrap'); calWrap.innerHTML='';
      const endMonth = new Date(cursor.getFullYear(), cursor.getMonth()+spanMonths-1, 1);
      $('#monthTitle').textContent = `${cursor.toLocaleDateString(undefined,{ month:'long', year:'numeric' })} → ${endMonth.toLocaleDateString(undefined,{ month:'long', year:'numeric' })}`;
      for(let i=0;i<spanMonths;i++){
        calWrap.appendChild(renderMonthBlock(new Date(cursor.getFullYear(), cursor.getMonth()+i, 1)));
      }
      paintAll();
    }

    function chip(name, whoId, dayKey){
      const span=document.createElement('span');
      const mine = meId===whoId;
      const needSwap = daysMap[dayKey]?.swapRequestedIds?.includes(whoId);
      span.className = 'group inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-xs ' + (needSwap? 'bg-amber-100 border-amber-300 text-amber-900':'bg-slate-50');
      span.textContent = name;

      // toggle swap (only self)
      span.addEventListener('click', async (e)=>{
        e.stopPropagation(); if(!mine) return;
        const set = new Set(daysMap[dayKey]?.swapRequestedIds||[]);
        if(set.has(whoId)) set.delete(whoId); else set.add(whoId);
        daysMap[dayKey].swapRequestedIds = [...set]; paintCell(dayKey);
        try{ await toggleSwap(dayKey, whoId); }catch(err){ console.error(err); alert('Failed'); }
      });

      // remove (admin)
      if(currentProfile.isAdmin){
        const x=document.createElement('button'); x.textContent='×'; x.title='Remove from day'; x.className='ml-1 opacity-50 hover:opacity-100';
        x.addEventListener('click', async (e)=>{
          e.stopPropagation(); if(!currentProfile.isAdmin) return;
          const cur=(daysMap[dayKey]?.assignees)||[];
          const next = cur.filter(id=>id!==whoId);
          daysMap[dayKey].assignees = next;
          const newSwaps = (daysMap[dayKey].swapRequestedIds||[]).filter(x=> x!==whoId);
          daysMap[dayKey].swapRequestedIds = newSwaps;
          paintCell(dayKey);
          try{ await setAssignees(dayKey, next); }catch(e){ console.error(e); alert('Failed'); }
        });
        span.appendChild(x);
      }

      return span;
    }

    function hasAnyAssigned(teamId){
      if(!teamId) return false;
      const [a,b] = rangeKeyBounds(cursor, spanMonths);
      let cur = fromKey(a), end = fromKey(b);
      while(cur<=end){
        const k=toKey(cur);
        const d=daysMap[k];
        if(d && Array.isArray(d.assignees) && d.assignees.includes(teamId)) return true;
        cur = addDays(cur,1);
      }
      return false;
    }

    function paintCell(k){
      const d = daysMap[k] || { assignees:[], swapRequestedIds:[], note:'', checklist:{} };
      const chipsEl = $('#chips_'+k);
      const badgesEl = $('#badges_'+k);
      const actionsEl = $('#actions_'+k);
      const cell = $('#cell_'+k);
      if(!chipsEl||!actionsEl||!cell) return;

      chipsEl.innerHTML='';
      (d.assignees||[]).forEach(id=>{ const nm = nameById(id)||id; chipsEl.appendChild(chip(nm,id,k)); });

      // badges
      badgesEl.innerHTML='';
      const swapCount = (d.swapRequestedIds||[]).length;
      if(swapCount>0){ const b = document.createElement('span'); b.className='inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded-full bg-amber-100 border border-amber-300 text-amber-800'; b.textContent = 'swap ×'+swapCount; badgesEl.appendChild(b); }

      // actions
      actionsEl.innerHTML='';
      const mine = meId && (d.assignees||[]).includes(meId);
      const iHaveAny = hasAnyAssigned(meId);

      if(mine){
        const btnSwap = document.createElement('button'); btnSwap.className='text-xs px-2 py-1 rounded-md border hover:bg-slate-50';
        btnSwap.textContent = (d.swapRequestedIds||[]).includes(meId)? 'Cancel swap':'Need swap';
        btnSwap.onclick = ()=>{ const fakeChip = chip('x', meId, k); fakeChip.click(); };
        actionsEl.append(btnSwap);
      } else if((d.swapRequestedIds||[]).length>0 && meId){
        const giver = d.swapRequestedIds[0];
        const btnCover = document.createElement('button'); btnCover.className='text-xs px-2 py-1 rounded-md border hover:bg-slate-50'; btnCover.textContent='Cover today';
        btnCover.onclick = async ()=>{
          const nextAssignees = (d.assignees||[]).map(x=> x===giver? meId : x);
          const nextSwaps = (d.swapRequestedIds||[]).filter(x=> x!==giver);
          daysMap[k].assignees = nextAssignees; daysMap[k].swapRequestedIds = nextSwaps; paintCell(k);
          try{
            await ensureAnon();
            await setAssignees(k, nextAssignees);
            await updateDoc(doc(db,'days',k), { swapRequestedIds: nextSwaps, updatedAt: serverTimestamp() });
            await addSystemMsg(`🔁 ${nameById(meId)||'Someone'} covers ${nameById(giver)||giver} on ${k}.`, {type:'swap_accept', date:k, from:giver, to:meId}, meId);
          }catch(e){ console.error(e); alert('Failed to take shift'); }
        };
        actionsEl.append(btnCover);

        if(iHaveAny){
          const btnEx = document.createElement('button'); btnEx.className='text-xs px-2 py-1 rounded-md border hover:bg-slate-50'; btnEx.textContent='Propose exchange…';
          btnEx.onclick = async ()=>{
            showDateModal({
              title: 'Choose your date to swap',
              mode: 'simple',
              fromId: meId,
              toId: giver,
              onSelect: async (alt)=>{
                const dd = daysMap[alt];
                if(!dd || !(dd.assignees||[]).includes(meId)){ alert('You are not assigned on that date.'); return; }
                try{
                  await ensureAnon();
                  const u = auth.currentUser;
                  await addDoc(collection(db,'messages'), {
                    text:`🔁 Swap offer: ${nameById(meId)||'Someone'} proposes exchange ${k} ⇄ ${alt}`,
                    createdAt: serverTimestamp(), createdAtMs: Date.now(),
                    authorId: u?.uid||'anon',
                    authorName: nameById(meId)||'Anon',
                    kind:'swap_offer',
                    meta:{ from: meId, to: giver, date: k, askDate: alt },
                    visibleTeamIds:[meId, giver]
                  });
                }catch(e){ console.error(e); alert('Failed to send offer'); }
              }
            });
          };
          actionsEl.append(btnEx);
        }
      }

      const showSwapOnly = $('#toggleSwap').checked;
      if(showSwapOnly){ cell.style.display = swapCount>0 ? '' : 'none'; }
      else { cell.style.display=''; }
    }

    function paintAll(){
      const [a,b] = rangeKeyBounds(cursor, spanMonths);
      let cur = fromKey(a); const end = fromKey(b);
      while(cur <= end){ const dow=(cur.getDay()+6)%7; if(dow<5){ paintCell(toKey(cur)); } cur = addDays(cur,1); }
    }

    /******** 9) Toolbar ********/
    $('#prevMonth').addEventListener('click', ()=>{ cursor = new Date(cursor.getFullYear(), cursor.getMonth()-1, 1); renderCalendar(); subscribeRange(); });
    $('#nextMonth').addEventListener('click', ()=>{ cursor = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1); renderCalendar(); subscribeRange(); });
    $('#toggleSwap').addEventListener('change', paintAll);
    $('#spanSelect').addEventListener('change', (e)=>{ spanMonths = parseInt(e.target.value||'1',10); renderCalendar(); subscribeRange(); });

    $('#btnExportCSV').addEventListener('click', ()=>{
      const rows = [[ 'Date','Assignees','SwapNeeded' ]];
      const ymStart = `${cursor.getFullYear()}-${('0'+(cursor.getMonth()+1)).slice(-2)}`;
      const end = new Date(cursor.getFullYear(), cursor.getMonth()+spanMonths, 0);
      const ymEnd = `${end.getFullYear()}-${('0'+(end.getMonth()+1)).slice(-2)}`;
      Object.values(daysMap).filter(Boolean).forEach(d=>{
        if(!d.date) return;
        if(d.date >= ymStart && d.date <= ymEnd){
          rows.push([ d.date, (d.assignees||[]).map(nameById).filter(Boolean).join(' / '), (d.swapRequestedIds||[]).map(nameById).filter(Boolean).join(' / ') ]);
        }
      });
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='rota-'+ymStart+'__'+ymEnd+'.csv'; a.click(); URL.revokeObjectURL(url);
    });
    $('#btnPrint').addEventListener('click', ()=> window.print());

    // Publish: disabled until text
    const msgInput=$('#msgText'), publishBtn=$('#btnPublish');
    function togglePublishBtn(){ publishBtn.disabled = (msgInput.value.trim().length===0); }
    msgInput.addEventListener('input',togglePublishBtn); togglePublishBtn();

    $('#btnPublish').addEventListener('click', async ()=>{
      await ensureAnon();
      const text = $('#msgText').value.trim(); if(!text) return alert('Empty');
      const u = auth.currentUser;
      try{
        await addDoc(collection(db,'messages'), {
          text, attachments: [], createdAt: serverTimestamp(), createdAtMs: Date.now(), resolvedAt: null,
          authorId: u?.uid||'anon',
          authorName: currentProfile.isAdmin ? ADMIN_LABEL : (nameById(meId)||'Anon'),
          kind:'user', meta:{}
        });
        $('#msgText').value=''; togglePublishBtn();
      }catch(e){ console.error(e); alert('Failed to publish'); }
    });

    /******** 10) Checklist ********/
    function renderChecklist(){
      const k = toKey(new Date());
      const d = daysMap[k] || { checklist:{}, assignees:[], doneAt:null };
      const assigned = d.assignees||[];
      const isMine = meId && assigned.includes(meId);
      const area = $('#checklist'); area.innerHTML='';
      const info = $('#checklistInfo');

      const allChecked = dd => CHECKITEMS.every(it => dd.checklist && dd.checklist[it.id]);

      if(d.doneAt){
        $('#btnDone').classList.add('hidden');
        info.innerHTML = `🎉 Checklist completed for ${k}. Thank you!`;
        return;
      }

      if(isMine){
        info.textContent = `You are on duty today (${assigned.map(nameById).filter(Boolean).join(' / ')})`;
        CHECKITEMS.forEach(it=>{
          const row=document.createElement('label'); row.className='flex items-center gap-2 text-sm';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.className='rounded'; cb.checked=!!d.checklist?.[it.id];
          cb.addEventListener('change', async ()=>{
            const cc = { ...(daysMap[k]?.checklist||{}) }; cc[it.id] = cb.checked ? (meId||true) : null;
            try{ await saveChecklist(k, cc); }catch(e){ console.error(e); alert('Failed to save'); }
            const local=daysMap[k]||{checklist:{}}; local.checklist=cc; daysMap[k]=local; updateDoneBtn();
          });
          row.append(cb, document.createTextNode(it.label));
          area.appendChild(row);
        });
        const updateDoneBtn=()=>{ const dd=daysMap[k]||d; const dis=!allChecked(dd); $('#btnDone').disabled=dis; $('#btnDone').classList.toggle('btn-disabled',dis); };
        updateDoneBtn();
        $('#btnDone').classList.remove('hidden');
      }else{
        info.textContent = `Duty today: ${assigned.map(nameById).filter(Boolean).join(' / ') || '—'}`;
        $('#btnDone').classList.add('hidden');
      }
    }

    $('#btnDone').addEventListener('click', async ()=>{
      const k = toKey(new Date());
      const allOk = CHECKITEMS.every(it => (daysMap[k]?.checklist) && daysMap[k].checklist[it.id]);
      if(!allOk){ alert('Please complete all checklist items.'); return; }
      try{
        await markDone(k);
        daysMap[k] = { ...(daysMap[k]||{}), doneAt: new Date() };
        await addSystemMsg(`✅ Supplies checklist completed for ${k}.`, { type:'checklist_done', date:k }, meId);
        renderChecklist();
      }catch(e){ console.error(e); alert('Failed to mark done'); }
    });

    /******** 11) Modal ********/
    const dateModal = $('#dateModal');
    const dmTitle = $('#dm_title');
    const dmList = $('#dm_list');
    const dmHint = $('#dm_hint');
    const dmClose = $('#dm_close');
    const dmCancel = $('#dm_cancel');
    const dmOK = $('#dm_ok');
    const dmTabs = $('#dm_tabs');
    const dmTabMy = $('#dm_tab_my');
    const dmTabTheir = $('#dm_tab_their');

    let dmState = { mode:'simple', fromId:null, toId:null, pickFrom:'mine', selected:null, onSelect:null };

    function showDateModal({ title, mode='simple', fromId, toId, onSelect }){
      dmState = { mode, fromId, toId, pickFrom:'mine', selected:null, onSelect };
      dmTitle.textContent = title || 'Choose a date';
      dmOK.disabled = true;
      dmTabs.classList.toggle('hidden', mode !== 'counter');
      dmTabMy.classList.add('bg-slate-900','text-white');
      dmTabTheir.classList.remove('bg-slate-900','text-white');
      renderModalList();
      dateModal.classList.remove('hidden');
    }
    function hideDateModal(){ dateModal.classList.add('hidden'); dmState = { mode:'simple', fromId:null, toId:null, pickFrom:'mine', selected:null, onSelect:null }; }
    dmClose.onclick = hideDateModal; dmCancel.onclick = hideDateModal;
    dmTabMy.onclick = ()=>{ dmState.pickFrom='mine'; dmTabMy.classList.add('bg-slate-900','text-white'); dmTabTheir.classList.remove('bg-slate-900','text-white'); renderModalList(); };
    dmTabTheir.onclick = ()=>{ dmState.pickFrom='their'; dmTabTheir.classList.add('bg-slate-900','text-white'); dmTabMy.classList.remove('bg-slate-900','text-white'); renderModalList(); };
    dmOK.onclick = ()=>{ if(!dmState.selected || !dmState.onSelect) return; dmState.onSelect(dmState.selected); hideDateModal(); };

    function datesFor(teamId){
      const out=[]; if(!teamId) return out;
      const [a,b] = rangeKeyBounds(cursor, spanMonths);
      let cur = fromKey(a), end = fromKey(b);
      while(cur<=end){
        const k = toKey(cur);
        const d=daysMap[k];
        if(d && Array.isArray(d.assignees) && d.assignees.includes(teamId)) out.push(k);
        cur = addDays(cur,1);
      }
      return out.sort();
    }

    function renderModalList(){
      dmList.innerHTML = ''; dmHint.textContent = ''; dmOK.disabled = true; dmState.selected = null;
      const label = dmState.mode==='counter'
        ? (dmState.pickFrom==='mine' ? 'Your assigned dates' : `${nameById(dmState.toId)||'Their'} assigned dates`)
        : 'Your assigned dates';

      const ds = dmState.pickFrom==='mine' ? datesFor(meId) : datesFor(dmState.toId);
      if(ds.length===0){ const p=document.createElement('p'); p.className='text-sm text-slate-500'; p.textContent='No assigned dates in the loaded range.'; dmList.appendChild(p); return; }
      dmHint.textContent = label;

      ds.forEach(k=>{
        const row=document.createElement('button'); row.type='button'; row.className='w-full text-left px-3 py-2 rounded-lg border hover:bg-slate-50'; row.textContent = k;
        row.onclick = ()=>{ $$('#dm_list button').forEach(b=> b.classList.remove('ring-2','ring-slate-900')); row.classList.add('ring-2','ring-slate-900'); dmState.selected = k; dmOK.disabled = false; };
        dmList.appendChild(row);
      });
    }

    /******** 12) Boot ********/
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ await signInAnonymously(auth); return; }

      // подтверждаем/создаём профиль с teamId (только teamId!)
      await saveMyProfileTeam();

      subscribeProfile();
      subscribeRange();
      await resubscribeMessages();
      renderHeader();
      renderCalendar();
      renderChecklist();
    });
  </script>
</body>
</html>
